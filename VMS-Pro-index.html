<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VMS ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===== RESET & TOKENS ===== */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#07111f;
  --bg2:#0c1a2e;
  --bg3:#111f35;
  --bg4:#162540;
  --accent:#0ea5e9;
  --accent2:#38bdf8;
  --teal:#14b8a6;
  --green:#22c55e;
  --amber:#f59e0b;
  --red:#ef4444;
  --violet:#8b5cf6;
  --border:rgba(255,255,255,0.07);
  --border2:rgba(14,165,233,0.25);
  --text:#e2e8f0;
  --text2:#64748b;
  --text3:#94a3b8;
  --radius:10px;
  --radius2:16px;
  --shadow:0 8px 32px rgba(0,0,0,0.5);
  --shadow2:0 0 0 1px rgba(14,165,233,0.2),0 8px 32px rgba(14,165,233,0.1);
}
html,body{height:100%;font-family:'Sarabun',sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden;font-size:15px}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}

/* ===== GRID BACKGROUND ===== */
body::before{
  content:'';position:fixed;inset:0;
  background-image:
    linear-gradient(rgba(14,165,233,0.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(14,165,233,0.03) 1px,transparent 1px);
  background-size:40px 40px;
  pointer-events:none;z-index:0;
}

/* ========== LOGIN PAGE ========== */
#loginPage{
  position:fixed;inset:0;z-index:1000;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);
}
.login-wrap{
  width:100%;max-width:440px;padding:20px;
  animation:fadeUp .5s ease both;
}
@keyframes fadeUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.login-logo{text-align:center;margin-bottom:32px}
.login-logo .logo-glow{
  display:inline-flex;align-items:center;justify-content:center;
  width:64px;height:64px;border-radius:18px;
  background:linear-gradient(135deg,var(--accent),var(--teal));
  font-size:28px;margin-bottom:16px;
  box-shadow:0 0 40px rgba(14,165,233,0.4);
  animation:logoPulse 3s ease infinite;
}
@keyframes logoPulse{0%,100%{box-shadow:0 0 40px rgba(14,165,233,0.4)}50%{box-shadow:0 0 60px rgba(14,165,233,0.7)}}
.login-logo h1{font-size:22px;font-weight:800;letter-spacing:-.5px}
.login-logo h1 span{color:var(--accent)}
.login-logo p{color:var(--text2);font-size:13px;margin-top:4px}

.login-card{
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:var(--radius2);
  padding:32px;
  box-shadow:var(--shadow2);
  position:relative;overflow:hidden;
}
.login-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
}
.login-error{
  background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);
  color:#fca5a5;border-radius:8px;padding:10px 14px;font-size:13px;
  margin-bottom:16px;display:none;align-items:center;gap:8px;
}
.login-error.show{display:flex}
.google-btn{
  width:100%;padding:11px;border-radius:8px;
  background:rgba(255,255,255,0.06);border:1px solid var(--border);
  color:var(--text);font-size:14px;font-family:'Sarabun',sans-serif;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  transition:all .2s;margin-bottom:20px;font-weight:600;
}
.google-btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.15)}
.divider{display:flex;align-items:center;gap:12px;margin-bottom:20px;color:var(--text2);font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* FORM ELEMENTS */
.fgroup{margin-bottom:16px}
.fgroup label{display:block;font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.finput{
  width:100%;padding:11px 14px;
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border);
  border-radius:8px;color:var(--text);
  font-size:14px;font-family:'Sarabun',sans-serif;
  outline:none;transition:all .2s;
}
.finput:focus{border-color:var(--accent);background:rgba(14,165,233,0.06);box-shadow:0 0 0 3px rgba(14,165,233,0.1)}
.finput::placeholder{color:var(--text2)}
select.finput option{background:var(--bg3)}
textarea.finput{resize:vertical;min-height:80px}

.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:9px 18px;border-radius:8px;border:none;
  font-size:13px;font-weight:700;cursor:pointer;
  transition:all .15s;font-family:'Sarabun',sans-serif;white-space:nowrap;
}
.btn-primary{background:linear-gradient(135deg,var(--accent),#0284c7);color:#fff}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px);box-shadow:0 4px 16px rgba(14,165,233,0.4)}
.btn-success{background:linear-gradient(135deg,var(--green),#16a34a);color:#fff}
.btn-success:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-danger{background:rgba(239,68,68,.15);color:#fca5a5;border:1px solid rgba(239,68,68,.3)}
.btn-danger:hover{background:rgba(239,68,68,.25)}
.btn-warning{background:rgba(245,158,11,.15);color:#fcd34d;border:1px solid rgba(245,158,11,.3)}
.btn-warning:hover{background:rgba(245,158,11,.25)}
.btn-ghost{background:rgba(255,255,255,.05);color:var(--text3);border:1px solid var(--border)}
.btn-ghost:hover{background:rgba(255,255,255,.09);color:var(--text)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-xs{padding:4px 8px;font-size:11px}
.btn-full{width:100%;justify-content:center;padding:12px}

/* ========== LAYOUT ========== */
#app{display:none;height:100vh;overflow:hidden;position:relative;z-index:1}
#app.visible{display:flex}

/* SIDEBAR */
.sidebar{
  width:240px;flex-shrink:0;
  background:var(--bg2);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
  transition:width .3s ease;
}
.sidebar.collapsed{width:60px}
.sidebar-header{
  padding:16px;
  display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--border);
  min-height:60px;
}
.brand-icon{
  width:34px;height:34px;border-radius:9px;
  background:linear-gradient(135deg,var(--accent),var(--teal));
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
  box-shadow:0 0 20px rgba(14,165,233,0.3);
}
.brand-text{overflow:hidden;white-space:nowrap}
.brand-text .name{font-size:13px;font-weight:800;letter-spacing:-.3px}
.brand-text .name span{color:var(--accent)}
.brand-text .version{font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace}

.nav-scroll{flex:1;overflow-y:auto;padding:8px 0}
.nav-section{
  padding:12px 16px 4px;
  font-size:10px;font-weight:700;
  color:var(--text2);text-transform:uppercase;
  letter-spacing:1px;font-family:'JetBrains Mono',monospace;
  white-space:nowrap;overflow:hidden;
}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 16px;
  cursor:pointer;transition:all .15s;
  color:var(--text2);font-size:13px;
  border-left:2px solid transparent;
  position:relative;white-space:nowrap;overflow:hidden;
}
.nav-item:hover{background:rgba(255,255,255,.04);color:var(--text)}
.nav-item.active{background:rgba(14,165,233,.1);color:var(--accent2);border-left-color:var(--accent)}
.nav-item .nicon{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-item .nlabel{overflow:hidden;text-overflow:ellipsis}
.nav-badge{
  margin-left:auto;background:var(--red);color:#fff;
  font-size:10px;font-weight:800;padding:2px 6px;
  border-radius:10px;font-family:'JetBrains Mono',monospace;
  flex-shrink:0;
}

.sidebar-footer{
  padding:12px;border-top:1px solid var(--border);
}
.user-pill{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:8px;
  background:rgba(255,255,255,.03);cursor:pointer;
  transition:background .15s;white-space:nowrap;overflow:hidden;
}
.user-pill:hover{background:rgba(255,255,255,.07)}
.avatar{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:800;flex-shrink:0;
}
.user-pill-info{overflow:hidden}
.user-pill-info .uname{font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis}
.user-pill-info .urole{font-size:10px;color:var(--text2)}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{
  height:60px;flex-shrink:0;
  background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;gap:16px;
}
.topbar-left{display:flex;align-items:center;gap:12px}
.hamburger{
  width:32px;height:32px;border-radius:7px;
  background:transparent;border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px;color:var(--text3);
  transition:all .15s;
}
.hamburger:hover{background:rgba(255,255,255,.06);color:var(--text)}
.page-title{font-size:15px;font-weight:700}
.topbar-right{display:flex;align-items:center;gap:8px}
.tbar-btn{
  position:relative;width:34px;height:34px;border-radius:8px;
  background:rgba(255,255,255,.04);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:15px;color:var(--text3);
  transition:all .15s;
}
.tbar-btn:hover{background:rgba(255,255,255,.08);color:var(--text)}
.tbar-dot{
  position:absolute;top:-3px;right:-3px;
  width:15px;height:15px;border-radius:50%;
  background:var(--red);font-size:9px;
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:800;border:2px solid var(--bg2);
  font-family:'JetBrains Mono',monospace;
}
.conn-status{
  display:flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:20px;
  font-size:11px;font-family:'JetBrains Mono',monospace;
  background:rgba(255,255,255,.04);border:1px solid var(--border);
}
.conn-dot{width:6px;height:6px;border-radius:50%;animation:blink 2s ease infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.conn-status.connected .conn-dot{background:var(--green)}
.conn-status.offline .conn-dot{background:var(--red)}

/* PAGE CONTENT */
.page-wrap{flex:1;overflow-y:auto;padding:24px}
.page{display:none;animation:pageIn .25s ease both}
.page.active{display:block}
@keyframes pageIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.ph{margin-bottom:24px;display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
.ph h1{font-size:22px;font-weight:800;letter-spacing:-.4px}
.ph p{font-size:13px;color:var(--text3);margin-top:3px}
.ph-actions{display:flex;gap:8px;flex-shrink:0;align-items:flex-start}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--radius2);padding:20px;
  position:relative;overflow:hidden;
  transition:transform .2s,box-shadow .2s;
}
.stat:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.stat::after{
  content:'';position:absolute;
  bottom:-20px;right:-20px;
  width:80px;height:80px;border-radius:50%;
  opacity:.08;
}
.stat.c-blue::after{background:var(--accent)}
.stat.c-teal::after{background:var(--teal)}
.stat.c-green::after{background:var(--green)}
.stat.c-amber::after{background:var(--amber)}
.stat.c-red::after{background:var(--red)}
.stat .s-label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.stat .s-val{font-size:30px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-1px}
.stat.c-blue .s-val{color:var(--accent2)}
.stat.c-teal .s-val{color:var(--teal)}
.stat.c-green .s-val{color:var(--green)}
.stat.c-amber .s-val{color:var(--amber)}
.stat.c-red .s-val{color:var(--red)}
.stat .s-sub{font-size:11px;color:var(--text2);margin-top:4px}

/* CARDS */
.card{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--radius2);overflow:hidden;
  margin-bottom:20px;
}
.card-head{
  padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  flex-wrap:wrap;
}
.card-head h3{font-size:14px;font-weight:700}
.card-body{padding:20px}

/* TABLES */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{
  text-align:left;padding:10px 14px;
  font-size:11px;font-weight:700;color:var(--text2);
  text-transform:uppercase;letter-spacing:.5px;
  border-bottom:1px solid var(--border);
  background:rgba(255,255,255,.02);
  white-space:nowrap;
}
tbody td{
  padding:12px 14px;font-size:13px;
  border-bottom:1px solid rgba(255,255,255,.03);
  vertical-align:middle;
}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,.02)}
.td-actions{display:flex;gap:4px}

/* BADGES */
.badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 9px;border-radius:20px;
  font-size:11px;font-weight:700;white-space:nowrap;
}
.badge::before{content:'‚óè';font-size:7px}
.b-pending{background:rgba(245,158,11,.12);color:var(--amber);border:1px solid rgba(245,158,11,.2)}
.b-approved{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.b-rejected{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.2)}
.b-dispatched{background:rgba(20,184,166,.12);color:var(--teal);border:1px solid rgba(20,184,166,.2)}
.b-inprogress{background:rgba(14,165,233,.12);color:var(--accent2);border:1px solid rgba(14,165,233,.2)}
.b-completed{background:rgba(100,116,139,.12);color:var(--text3);border:1px solid rgba(100,116,139,.2)}
.b-active{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.b-maintenance{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.2)}
.b-inactive{background:rgba(100,116,139,.12);color:var(--text3);border:1px solid rgba(100,116,139,.2)}

/* TAG CHIP */
.chip{
  display:inline-block;padding:2px 8px;border-radius:5px;
  font-size:11px;font-family:'JetBrains Mono',monospace;
  background:rgba(255,255,255,.07);color:var(--text3);
}

/* MODALS */
.modal-bg{
  position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
  display:none;align-items:center;justify-content:center;padding:20px;
}
.modal-bg.open{display:flex}
.modal{
  background:var(--bg3);border:1px solid var(--border2);
  border-radius:var(--radius2);width:100%;
  max-height:92vh;overflow-y:auto;
  animation:modalIn .2s ease;
  position:relative;
}
.modal::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal.md{max-width:560px}
.modal.lg{max-width:760px}
.modal.xl{max-width:960px}
.modal-head{
  padding:20px 24px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-head h3{font-size:15px;font-weight:700}
.modal-close{
  width:28px;height:28px;border-radius:6px;
  background:rgba(255,255,255,.06);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px;color:var(--text3);
  transition:all .15s;
}
.modal-close:hover{background:rgba(239,68,68,.15);color:#fca5a5;border-color:rgba(239,68,68,.3)}
.modal-body{padding:24px}
.modal-foot{
  padding:16px 24px;border-top:1px solid var(--border);
  display:flex;justify-content:flex-end;gap:10px;
}

/* FORM GRID */
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.fg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.fcol2{grid-column:1/-1}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:20px}
.tab{
  padding:10px 18px;font-size:13px;font-weight:600;
  cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;
  transition:all .15s;white-space:nowrap;
}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
.tab-panel{display:none}.tab-panel.active{display:block}

/* ALERT */
.alert{
  display:flex;align-items:flex-start;gap:12px;
  padding:12px 16px;border-radius:10px;margin-bottom:16px;font-size:13px;
}
.alert-info{background:rgba(14,165,233,.08);border:1px solid rgba(14,165,233,.2);color:#7dd3fc}
.alert-warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:#fcd34d}
.alert-success{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:#86efac}
.alert-err{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#fca5a5}

/* TIMELINE */
.timeline{display:flex;align-items:center;margin-bottom:20px}
.tl-step{display:flex;align-items:center;flex:1}
.tl-dot{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:13px;
  border:2px solid var(--border);background:var(--bg3);flex-shrink:0;
  position:relative;z-index:1;
}
.tl-line{flex:1;height:2px;background:var(--border)}
.tl-step.done .tl-dot{border-color:var(--green);background:rgba(34,197,94,.15);color:var(--green)}
.tl-step.done .tl-line,.tl-step.done+.tl-step .tl-line{background:var(--green)}
.tl-step.curr .tl-dot{border-color:var(--accent);background:rgba(14,165,233,.15);animation:tlPulse 2s infinite}
@keyframes tlPulse{0%,100%{box-shadow:0 0 0 0 rgba(14,165,233,.4)}50%{box-shadow:0 0 0 8px rgba(14,165,233,0)}}

/* SEARCH BAR */
.search-row{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.search-input{
  flex:1;min-width:200px;padding:9px 14px 9px 36px;
  background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:13px;
  font-family:'Sarabun',sans-serif;outline:none;transition:all .2s;
  position:relative;
}
.search-input:focus{border-color:var(--accent)}
.search-wrap{position:relative;flex:1;min-width:200px}
.search-wrap .search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--text2);pointer-events:none}

/* CALENDAR */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-day-head{text-align:center;font-size:10px;font-weight:700;color:var(--text2);padding:6px 0;text-transform:uppercase}
.cal-day{
  min-height:80px;padding:6px;border-radius:6px;
  background:rgba(255,255,255,.02);border:1px solid var(--border);
  cursor:pointer;transition:background .15s;
}
.cal-day:hover{background:rgba(255,255,255,.04)}
.cal-day.today{border-color:var(--accent);background:rgba(14,165,233,.06)}
.cal-day.other-month .cal-num{color:var(--text2)}
.cal-num{font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:4px}
.cal-event{
  font-size:10px;padding:2px 5px;border-radius:3px;
  margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  cursor:pointer;
}
.cal-event.ev-blue{background:rgba(14,165,233,.2);color:var(--accent2)}
.cal-event.ev-green{background:rgba(34,197,94,.2);color:var(--green)}
.cal-event.ev-amber{background:rgba(245,158,11,.2);color:var(--amber)}

/* PDF PREVIEW AREA */
.pdf-zone{
  border:2px dashed var(--border);border-radius:10px;
  padding:24px;text-align:center;cursor:pointer;
  transition:all .2s;
}
.pdf-zone:hover{border-color:var(--accent);background:rgba(14,165,233,.04)}
.pdf-zone.drag-over{border-color:var(--accent);background:rgba(14,165,233,.08)}
.pdf-list{display:grid;gap:8px;margin-top:12px}
.pdf-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 14px;border-radius:8px;
  background:rgba(255,255,255,.03);border:1px solid var(--border);
}
.pdf-icon{font-size:20px;flex-shrink:0}
.pdf-info{flex:1;overflow:hidden}
.pdf-info .pdf-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pdf-info .pdf-size{font-size:11px;color:var(--text2)}

/* GANTT */
.gantt{overflow-x:auto}
.gantt-inner{min-width:800px}
.gantt-head{display:flex;border-bottom:1px solid var(--border);padding-bottom:8px}
.gantt-res{width:180px;flex-shrink:0;font-size:11px;color:var(--text2);font-weight:700;padding:0 12px}
.gantt-tl{flex:1;display:flex}
.gantt-h{
  flex:1;text-align:center;font-size:10px;
  font-family:'JetBrains Mono',monospace;color:var(--text2);
  border-left:1px solid rgba(255,255,255,.04);padding:0 4px;
}
.gantt-row{display:flex;min-height:50px;align-items:center;border-bottom:1px solid rgba(255,255,255,.03)}
.gantt-lbl{width:180px;flex-shrink:0;padding:8px 12px}
.gantt-lbl .v-name{font-size:12px;font-weight:700}
.gantt-lbl .v-sub{font-size:11px;color:var(--text2)}
.gantt-track{flex:1;position:relative;height:50px}
.g-block{
  position:absolute;top:8px;height:34px;
  border-radius:6px;display:flex;align-items:center;
  padding:0 8px;font-size:11px;font-weight:700;
  white-space:nowrap;overflow:hidden;cursor:pointer;
  transition:filter .2s;
}
.g-block:hover{filter:brightness(1.2)}
.g-blue{background:rgba(14,165,233,.2);border:1px solid rgba(14,165,233,.4);color:var(--accent2)}
.g-teal{background:rgba(20,184,166,.2);border:1px solid rgba(20,184,166,.4);color:var(--teal)}
.g-green{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.4);color:var(--green)}
.g-red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}

/* NOTIF PANEL */
.notif-panel{
  position:fixed;top:0;right:0;bottom:0;width:360px;
  background:var(--bg2);border-left:1px solid var(--border);
  z-index:400;transform:translateX(100%);
  transition:transform .3s ease;display:flex;flex-direction:column;
}
.notif-panel.open{transform:translateX(0)}
.np-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.np-head h3{font-size:14px;font-weight:700}
.np-list{flex:1;overflow-y:auto}
.np-item{
  padding:14px 20px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .15s;
  border-left:3px solid transparent;
}
.np-item:hover{background:rgba(255,255,255,.03)}
.np-item.unread{border-left-color:var(--accent)}
.np-item .npt{font-size:13px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.np-item .npb{font-size:12px;color:var(--text3);line-height:1.5}
.np-item .npts{font-size:11px;color:var(--text2);margin-top:6px;font-family:'JetBrains Mono',monospace}
.np-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0}

/* SETTINGS FORM */
.settings-section{margin-bottom:28px}
.settings-section h4{font-size:13px;font-weight:700;color:var(--accent2);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.settings-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 0;border-bottom:1px solid rgba(255,255,255,.03);
  gap:16px;
}
.settings-row:last-child{border-bottom:none}
.settings-row .s-info .s-title{font-size:13px;font-weight:600}
.settings-row .s-info .s-desc{font-size:12px;color:var(--text2);margin-top:2px}
/* Toggle */
.toggle{
  position:relative;width:44px;height:24px;flex-shrink:0;cursor:pointer;
}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{
  position:absolute;inset:0;background:rgba(255,255,255,.1);
  border-radius:12px;transition:background .2s;
}
.toggle input:checked~.toggle-track{background:var(--accent)}
.toggle-thumb{
  position:absolute;width:18px;height:18px;
  background:#fff;border-radius:50%;top:3px;left:3px;
  transition:left .2s;box-shadow:0 2px 4px rgba(0,0,0,.3);
}
.toggle input:checked~.toggle-track~.toggle-thumb,
.toggle input:checked+.toggle-track+.toggle-thumb{left:23px}

/* TOAST */
#toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--bg4);border:1px solid var(--border2);
  border-radius:10px;padding:12px 20px;font-size:13px;
  box-shadow:var(--shadow2);z-index:600;
  transition:transform .3s ease,opacity .3s ease;
  opacity:0;display:flex;align-items:center;gap:10px;max-width:400px;
  white-space:nowrap;pointer-events:none;
}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* REPORT BARS */
.rbar{margin-bottom:14px}
.rbar-head{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px}
.rbar-track{background:rgba(255,255,255,.06);border-radius:4px;height:10px;overflow:hidden}
.rbar-fill{height:100%;border-radius:4px;transition:width 1s ease}

/* RESPONSIVE */
@media(max-width:768px){
  .stats{grid-template-columns:1fr 1fr}
  .fg2,.fg3{grid-template-columns:1fr}
  .fcol2{grid-column:1}
  .sidebar{position:fixed;top:0;left:0;bottom:0;z-index:200;transform:translateX(-100%)}
  .sidebar.mobile-open{transform:translateX(0)}
  .main{margin-left:0!important}
  .ph{flex-direction:column}
}
@media(max-width:480px){
  .stats{grid-template-columns:1fr}
  .topbar .conn-status{display:none}
}
</style>
</head>
<body>

<!-- ============================================================
     LOGIN PAGE
============================================================ -->
<div id="loginPage">
  <div class="login-wrap">
    <div class="login-logo">
      <div class="logo-glow">üöó</div>
      <h1>VMS <span>Pro</span></h1>
      <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
    </div>
    <div class="login-card">
      <div class="login-error" id="loginErr">
        <span>‚ö†Ô∏è</span><span id="loginErrMsg">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
      </div>

      <button class="google-btn" onclick="loginWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google (OAuth)
      </button>

      <div class="divider">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</div>

      <div class="fgroup">
        <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input class="finput" id="loginEmail" type="email" placeholder="yourname@company.com" value="admin@company.com" autocomplete="email">
      </div>
      <div class="fgroup">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <div style="position:relative">
          <input class="finput" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin123" style="padding-right:44px" autocomplete="current-password">
          <span onclick="togglePass()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:16px;color:var(--text2)" id="eyeBtn">üëÅÔ∏è</span>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--text3)">
          <input type="checkbox" checked style="accent-color:var(--accent)"> ‡∏à‡∏î‡∏à‡∏≥‡∏â‡∏±‡∏ô
        </label>
        <a href="#" style="font-size:13px;color:var(--accent2);text-decoration:none">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
      </div>
      <button class="btn btn-primary btn-full" onclick="doLogin()" id="loginBtn">
        <span id="loginBtnTxt">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
      </button>
      <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--text2)">
        üîí ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AES-256 Encryption ¬∑ Protected by reCAPTCHA<br>
        <span style="font-family:'JetBrains Mono',monospace">Demo: admin@company.com / admin123</span>
      </div>
    </div>
    <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--text2)">
      ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏≠‡∏∑‡πà‡∏ô: user@co.th / manager@co.th / driver@co.th (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: 1234)
    </div>
  </div>
</div>

<!-- ============================================================
     MAIN APPLICATION
============================================================ -->
<div id="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand-icon">üöó</div>
      <div class="brand-text">
        <div class="name">VMS <span>Pro</span></div>
        <div class="version">v2.1.0</div>
      </div>
    </div>
    <nav class="nav-scroll" id="mainNav"></nav>
    <div class="sidebar-footer">
      <div class="user-pill" onclick="showPage('settings')">
        <div class="avatar" id="avatarEl" style="background:rgba(14,165,233,.2);color:var(--accent2)">AD</div>
        <div class="user-pill-info">
          <div class="uname" id="uNameEl">Admin User</div>
          <div class="urole" id="uRoleEl">System Admin</div>
        </div>
        <span style="font-size:14px;color:var(--text2);margin-left:auto">‚öôÔ∏è</span>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
        <div class="page-title" id="pageTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
      </div>
      <div class="topbar-right">
        <div class="conn-status connected" id="connStatus">
          <div class="conn-dot"></div>
          <span id="connTxt">Google Sheets</span>
        </div>
        <div class="tbar-btn" onclick="syncData()" title="‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">üîÑ</div>
        <div class="tbar-btn" onclick="toggleNotif()" title="‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
          üîî<div class="tbar-dot" id="notifCount">3</div>
        </div>
        <div class="tbar-btn" onclick="doLogout()" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">üö™</div>
      </div>
    </div>

    <div class="page-wrap">

      <!-- ===== DASHBOARD ===== -->
      <div class="page active" id="page-dashboard">
        <div class="ph">
          <div><h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1><p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï <span id="lastSync">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ</span></p></div>
          <div class="ph-actions">
            <button class="btn btn-ghost btn-sm" onclick="syncData()">üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('mBooking')">+ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
        <div class="stats" id="dashStats"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card">
            <div class="card-head"><h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3><button class="btn btn-ghost btn-xs" onclick="showPage('bookings')">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</button></div>
            <div class="tbl-wrap"><table id="dashBookingTable"></table></div>
          </div>
          <div class="card">
            <div class="card-head"><h3>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô</h3></div>
            <div id="dashAlerts"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h3>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Google Calendar ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
            <button class="btn btn-ghost btn-xs" onclick="showPage('calendar')">‡∏Ç‡∏¢‡∏≤‡∏¢ ‚Üí</button>
          </div>
          <div class="card-body" id="miniCalBody"></div>
        </div>
      </div>

      <!-- ===== BOOKINGS ===== -->
      <div class="page" id="page-bookings">
        <div class="ph">
          <div><h1>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</h1><p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p></div>
          <div class="ph-actions">
            <button class="btn btn-ghost btn-sm" onclick="exportToSheet('bookings')">üìä Export Sheet</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('mBooking')">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="search-row" style="margin:0;flex:1">
              <div class="search-wrap">
                <span class="search-icon">üîç</span>
                <input class="search-input finput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠..." oninput="filterTable(this,'bookingsTbl')">
              </div>
              <select class="finput" style="width:auto" onchange="filterByStatus(this,'bookingsTbl')">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                <option value="‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              </select>
            </div>
          </div>
          <div class="tbl-wrap"><table id="bookingsTbl"></table></div>
        </div>
      </div>

      <!-- ===== APPROVALS ===== -->
      <div class="page" id="page-approvals">
        <div class="ph">
          <div><h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h1><p>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</p></div>
        </div>
        <div class="alert alert-warn">‚ö†Ô∏è ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <strong id="pendingCount">0</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div class="card">
          <div class="card-head"><h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3></div>
          <div id="approvalList"></div>
        </div>
      </div>

      <!-- ===== DISPATCH ===== -->
      <div class="page" id="page-dispatch">
        <div class="ph">
          <div><h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ</h1><p>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Dispatch Board</p></div>
          <div class="ph-actions">
            <button class="btn btn-ghost btn-sm" onclick="syncCalendar()">üìÖ Sync Calendar</button>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h3>Gantt Chart ‚Äî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
            <span style="font-size:12px;color:var(--text2)" id="ganttDate"></span>
          </div>
          <div class="card-body"><div class="gantt"><div class="gantt-inner" id="ganttBoard"></div></div></div>
        </div>
        <div class="card">
          <div class="card-head"><h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏ñ (Approved)</h3></div>
          <div id="dispatchQueue"></div>
        </div>
      </div>

      <!-- ===== VEHICLES ===== -->
      <div class="page" id="page-vehicles">
        <div class="ph">
          <div><h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</h1><p>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p></div>
          <div class="ph-actions">
            <button class="btn btn-ghost btn-sm" onclick="exportToSheet('vehicles')">üìä Export</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('mVehicle')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
        <div class="search-row">
          <div class="search-wrap" style="max-width:300px">
            <span class="search-icon">üîç</span>
            <input class="search-input finput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠..." oninput="filterTable(this,'vehiclesTbl')">
          </div>
          <select class="finput" style="width:auto" onchange="filterByStatus(this,'vehiclesTbl')">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</option><option>‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option><option>‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
          </select>
        </div>
        <div class="card"><div class="tbl-wrap"><table id="vehiclesTbl"></table></div></div>
      </div>

      <!-- ===== DRIVERS ===== -->
      <div class="page" id="page-drivers">
        <div class="ph">
          <div><h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</h1><p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</p></div>
          <div class="ph-actions">
            <button class="btn btn-ghost btn-sm" onclick="exportToSheet('drivers')">üìä Export</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('mDriver')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
          </div>
        </div>
        <div class="search-row">
          <div class="search-wrap" style="max-width:300px">
            <span class="search-icon">üîç</span>
            <input class="search-input finput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™..." oninput="filterTable(this,'driversTbl')">
          </div>
        </div>
        <div class="card"><div class="tbl-wrap"><table id="driversTbl"></table></div></div>
      </div>

      <!-- ===== CALENDAR ===== -->
      <div class="page" id="page-calendar">
        <div class="ph">
          <div><h1>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Google Calendar</h1><p>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar</p></div>
          <div class="ph-actions">
            <button class="btn btn-ghost btn-sm" onclick="prevMonth()">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
            <button class="btn btn-ghost btn-sm" onclick="nextMonth()">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            <button class="btn btn-primary btn-sm" onclick="syncCalendar()">üìÖ Sync Google Calendar</button>
          </div>
        </div>
        <div class="alert alert-info">‚ÑπÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏±‡∏ö Google Calendar ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß, ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ = ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥, ‡∏™‡∏µ‡∏™‡πâ‡∏° = ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>
        <div class="card">
          <div class="card-head">
            <h3 id="calMonthTitle"></h3>
            <div style="display:flex;gap:6px;font-size:12px;align-items:center">
              <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;border-radius:2px;background:rgba(34,197,94,.5);display:inline-block"></span>‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß</span>
              <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;border-radius:2px;background:rgba(14,165,233,.5);display:inline-block"></span>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
              <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;border-radius:2px;background:rgba(245,158,11,.5);display:inline-block"></span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
            </div>
          </div>
          <div class="card-body">
            <div class="cal-grid" id="calGrid"></div>
          </div>
        </div>
      </div>

      <!-- ===== DRIVER SCHEDULE (MY TRIPS) ===== -->
      <div class="page" id="page-mytrips">
        <div class="ph">
          <div><h1>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1><p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p></div>
        </div>
        <div id="myTripsList"></div>
      </div>

      <!-- ===== REPORTS ===== -->
      <div class="page" id="page-reports">
        <div class="ph">
          <div><h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1><p>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p></div>
          <div class="ph-actions">
            <select class="finput" style="width:auto" id="reportMonth">
              <option>‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568</option><option>‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏° 2568</option><option>‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô 2568</option>
            </select>
            <button class="btn btn-ghost btn-sm" onclick="exportReport()">üì• Export PDF</button>
            <button class="btn btn-primary btn-sm" onclick="sendEmailReport()">üìß ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Email</button>
          </div>
        </div>
        <div class="stats" id="reportStats"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card">
            <div class="card-head"><h3>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</h3></div>
            <div class="card-body" id="deptReport"></div>
          </div>
          <div class="card">
            <div class="card-head"><h3>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3></div>
            <div class="card-body"><div class="tbl-wrap"><table id="costTable"></table></div></div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô</h3></div>
          <div class="tbl-wrap"><table id="vehicleReportTbl"></table></div>
        </div>
      </div>

      <!-- ===== SETTINGS ===== -->
      <div class="page" id="page-settings">
        <div class="ph"><div><h1>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h1><p>‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤</p></div></div>
        <div class="tabs">
          <div class="tab active" onclick="switchTab('set-google')">Google Services</div>
          <div class="tab" onclick="switchTab('set-email')">Email / ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
          <div class="tab" onclick="switchTab('set-users')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          <div class="tab" onclick="switchTab('set-workflow')">Approval Workflow</div>
        </div>
        <div class="tab-panel active" id="set-google">
          <div class="settings-section">
            <h4>üîó Google Sheets (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h4>
            <div class="fgroup"><label>Google Spreadsheet ID</label>
              <input class="finput" id="sheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms" value="">
            </div>
            <div class="fgroup"><label>Service Account JSON (Base64)</label>
              <textarea class="finput" rows="3" placeholder='{"type":"service_account","project_id":"..."}'></textarea>
            </div>
            <div style="display:flex;gap:10px;margin-top:8px">
              <button class="btn btn-primary btn-sm" onclick="testSheetConn()">üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
              <button class="btn btn-success btn-sm" onclick="saveSheetConfig()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
          <div class="settings-section">
            <h4>üìÖ Google Calendar</h4>
            <div class="fgroup"><label>Calendar ID</label>
              <input class="finput" placeholder="your-email@gmail.com or calendar-id">
            </div>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏ñ</div><div class="s-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡πÉ‡∏ô Google Calendar ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div></div>
              <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</div><div class="s-desc">‡∏™‡πà‡∏á Reminder ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div></div>
              <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="connectCalendar()">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar</button>
          </div>
        </div>
        <div class="tab-panel" id="set-email">
          <div class="settings-section">
            <h4>üìß ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Email ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
            <div class="alert alert-info">‚ÑπÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Gmail API / Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
            <div class="fg2">
              <div class="fgroup"><label>Sender Email (Gmail)</label><input class="finput" placeholder="noreply@company.com"></div>
              <div class="fgroup"><label>Sender Name</label><input class="finput" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ VMS" value="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ VMS"></div>
            </div>
            <div class="fgroup"><label>Apps Script Web App URL</label>
              <input class="finput" placeholder="https://script.google.com/macros/s/YOUR_ID/exec" id="gasUrl">
            </div>
          </div>
          <div class="settings-section">
            <h4>üîî ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</div><div class="s-desc">‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div></div>
              <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</div><div class="s-desc">‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</div></div>
              <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div><div class="s-desc">‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</div></div>
              <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</div><div class="s-desc">‡πÅ‡∏à‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô 30 ‡∏ß‡∏±‡∏ô (‡∏û‡∏£‡∏ö./‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞)</div></div>
              <label class="toggle"><input type="checkbox" checked><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="sendTestEmail()">üìß ‡∏™‡πà‡∏á Test Email</button>
          </div>
        </div>
        <div class="tab-panel" id="set-users">
          <div class="card">
            <div class="card-head"><h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3><button class="btn btn-primary btn-sm" onclick="openModal('mUser')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button></div>
            <div class="tbl-wrap"><table id="usersTbl"></table></div>
          </div>
        </div>
        <div class="tab-panel" id="set-workflow">
          <div class="settings-section">
            <h4>‚öôÔ∏è ‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approval Workflow)</h4>
            <div class="fg2">
              <div class="fgroup"><label>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å)</label>
                <select class="finput"><option>‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (manager@co.th)</option></select>
              </div>
              <div class="fgroup"><label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ (Dispatcher)</label>
                <select class="finput"><option>‡∏ô‡∏≤‡∏¢ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö (admin@co.th)</option></select>
              </div>
            </div>
            <div class="settings-row">
              <div class="s-info"><div class="s-title">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ã‡πâ‡∏≥</div><div class="s-desc">‡∏´‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div></div>
              <label class="toggle"><input type="checkbox"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
            </div>
            <button class="btn btn-success btn-sm" style="margin-top:12px" onclick="showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--green)')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
          </div>
        </div>
      </div>

    </div><!-- end page-wrap -->
  </main>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="np-head">
    <h3>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô üîî</h3>
    <button class="btn btn-ghost btn-sm" onclick="toggleNotif()">‚úï</button>
  </div>
  <div class="np-list" id="npList"></div>
</div>

<!-- MODALS -->

<!-- Booking Modal -->
<div class="modal-bg" id="mBooking">
  <div class="modal lg">
    <div class="modal-head">
      <h3 id="mBookingTitle">üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h3>
      <div class="modal-close" onclick="closeModal('mBooking')">‚úï</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="bkEditId">
      <div class="fg2">
        <div class="fgroup"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label><input class="finput" id="bkDocNo" placeholder="DOC-2568-XXX"></div>
        <div class="fgroup"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏±‡∏ö</label><input class="finput" id="bkRefNo" placeholder="RCV-2568-XXX"></div>
        <div class="fgroup"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label><input class="finput" id="bkStart" type="datetime-local"></div>
        <div class="fgroup"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö</label><input class="finput" id="bkEnd" type="datetime-local"></div>
        <div class="fgroup"><label>‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input class="finput" id="bkFrom" placeholder="‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà"></div>
        <div class="fgroup"><label>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label><input class="finput" id="bkTo" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."></div>
        <div class="fgroup"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</label><input class="finput" id="bkPax" type="number" value="1" min="1"></div>
        <div class="fgroup"><label>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
          <select class="finput" id="bkDriver"><option value="1">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</option><option value="0">‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</option></select>
        </div>
        <div class="fgroup fcol2"><label>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label><textarea class="finput" id="bkPurpose" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå..."></textarea></div>
        <div class="fgroup fcol2">
          <label>‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</label>
          <div class="pdf-zone" id="pdfZone" onclick="document.getElementById('pdfInput').click()"
               ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
            <div style="font-size:28px;margin-bottom:8px">üìÑ</div>
            <div style="font-size:13px;font-weight:600">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            <div style="font-size:11px;color:var(--text2);margin-top:4px">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10MB</div>
            <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none" onchange="handlePdfUpload(event)">
          </div>
          <div class="pdf-list" id="pdfList"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mBooking')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveBooking()">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
    </div>
  </div>
</div>

<!-- Dispatch Modal -->
<div class="modal-bg" id="mDispatch">
  <div class="modal md">
    <div class="modal-head">
      <h3>üöó ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>
      <div class="modal-close" onclick="closeModal('mDispatch')">‚úï</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="dspBookingId">
      <div class="alert alert-info" id="dspInfo"></div>
      <div class="fgroup"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</label><select class="finput" id="dspVehicle"></select></div>
      <div class="fgroup"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</label><select class="finput" id="dspDriver"></select></div>
      <div class="fg2">
        <div class="fgroup"><label>‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö</label><input class="finput" id="dspMeet" value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏ä‡∏±‡πâ‡∏ô 1"></div>
        <div class="fgroup"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label><input class="finput" id="dspNote" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></div>
      </div>
      <div class="alert alert-success" style="margin-top:4px">üìß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á Email ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Calendar Event</div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mDispatch')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="confirmDispatch()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏ñ + ‡∏™‡πà‡∏á Email</button>
    </div>
  </div>
</div>

<!-- Vehicle Modal -->
<div class="modal-bg" id="mVehicle">
  <div class="modal md">
    <div class="modal-head">
      <h3 id="mVehicleTitle">üöå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</h3>
      <div class="modal-close" onclick="closeModal('mVehicle')">‚úï</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="vhEditId">
      <div class="fg2">
        <div class="fgroup"><label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label><input class="finput" id="vhPlate" placeholder="‡∏Å‡∏Ç-1234"></div>
        <div class="fgroup"><label>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ / ‡∏£‡∏∏‡πà‡∏ô</label><input class="finput" id="vhBrand" placeholder="Toyota Commuter"></div>
        <div class="fgroup"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
          <select class="finput" id="vhType"><option>‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option><option>‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option><option>‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option><option>‡∏£‡∏ñ‡∏ï‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà</option><option>‡∏£‡∏ñ‡∏ö‡∏±‡∏™</option></select>
        </div>
        <div class="fgroup"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (‡∏Ñ‡∏ô)</label><input class="finput" id="vhCap" type="number" value="10" min="1"></div>
        <div class="fgroup"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select class="finput" id="vhStatus"><option>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</option><option>‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option><option>‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option></select>
        </div>
        <div class="fgroup"><label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><input class="finput" id="vhMile" type="number" value="0"></div>
        <div class="fgroup"><label>‡∏û‡∏£‡∏ö. ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input class="finput" id="vhPrb" type="date"></div>
        <div class="fgroup"><label>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input class="finput" id="vhIns" type="date"></div>
        <div class="fgroup fcol2"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input class="finput" id="vhNote" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mVehicle')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveVehicle()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Driver Modal -->
<div class="modal-bg" id="mDriver">
  <div class="modal md">
    <div class="modal-head">
      <h3 id="mDriverTitle">üë®‚Äç‚úàÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</h3>
      <div class="modal-close" onclick="closeModal('mDriver')">‚úï</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="drEditId">
      <div class="fg2">
        <div class="fgroup"><label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input class="finput" id="drCode" placeholder="DRV-05"></div>
        <div class="fgroup"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="finput" id="drName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
        <div class="fgroup"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input class="finput" id="drPhone" placeholder="0xx-xxx-xxxx"></div>
        <div class="fgroup"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input class="finput" id="drEmail" type="email" placeholder="name@co.th"></div>
        <div class="fgroup"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà</label>
          <select class="finput" id="drLicType"><option>‡∏ó.1</option><option>‡∏ó.2</option><option>‡∏ó.3</option><option>‡∏ó.4</option></select>
        </div>
        <div class="fgroup"><label>‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input class="finput" id="drLicExp" type="date"></div>
        <div class="fgroup"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select class="finput" id="drStatus"><option>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</option><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option><option>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</option><option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option></select>
        </div>
        <div class="fgroup"><label>‡πÅ‡∏ú‡∏ô‡∏Å</label><input class="finput" id="drDept" placeholder="‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞" value="‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mDriver')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveDriver()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- User Modal -->
<div class="modal-bg" id="mUser">
  <div class="modal md">
    <div class="modal-head"><h3>üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><div class="modal-close" onclick="closeModal('mUser')">‚úï</div></div>
    <div class="modal-body">
      <div class="fg2">
        <div class="fgroup"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="finput" id="usrName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
        <div class="fgroup"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input class="finput" id="usrEmail" type="email" placeholder="name@company.com"></div>
        <div class="fgroup"><label>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
          <select class="finput" id="usrRole">
            <option value="user">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ (User)</option>
            <option value="manager">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Manager)</option>
            <option value="admin">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (Admin)</option>
            <option value="driver">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (Driver)</option>
          </select>
        </div>
        <div class="fgroup"><label>‡πÅ‡∏ú‡∏ô‡∏Å</label><input class="finput" id="usrDept" placeholder="‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£"></div>
        <div class="fgroup"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input class="finput" id="usrPass" type="password" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"></div>
        <div class="fgroup"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select class="finput" id="usrStatus"><option value="active">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option><option value="inactive">‡∏£‡∏∞‡∏á‡∏±‡∏ö</option></select>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mUser')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveUser()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Reject Modal -->
<div class="modal-bg" id="mReject">
  <div class="modal md" style="max-width:420px">
    <div class="modal-head"><h3>‚ùå ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3><div class="modal-close" onclick="closeModal('mReject')">‚úï</div></div>
    <div class="modal-body">
      <input type="hidden" id="rejectId">
      <div class="fgroup"><label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
        <select class="finput" id="rejectReason">
          <option>‡∏£‡∏ñ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß</option>
          <option>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</option>
          <option>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</option>
          <option>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</option>
          <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</option>
        </select>
      </div>
      <div class="fgroup"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label><textarea class="finput" id="rejectNote" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mReject')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-danger" onclick="confirmReject()">‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ + ‡∏™‡πà‡∏á Email</button>
    </div>
  </div>
</div>

<!-- Trip Update Modal -->
<div class="modal-bg" id="mTripUpdate">
  <div class="modal md" style="max-width:480px">
    <div class="modal-head"><h3 id="mTripTitle">üöó ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h3><div class="modal-close" onclick="closeModal('mTripUpdate')">‚úï</div></div>
    <div class="modal-body">
      <input type="hidden" id="tripUpdateId">
      <div class="alert alert-info" id="tripInfo"></div>
      <div class="fg2">
        <div class="fgroup"><label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏°.)</label><input class="finput" id="tripMileStart" type="number"></div>
        <div class="fgroup"><label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏Å‡∏°.)</label><input class="finput" id="tripMileEnd" type="number"></div>
        <div class="fgroup"><label>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input class="finput" id="tripFuel" type="number" value="0"></div>
        <div class="fgroup"><label>‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input class="finput" id="tripToll" type="number" value="0"></div>
        <div class="fgroup fcol2"><label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ PDF</label>
          <div class="pdf-zone" style="padding:14px" onclick="document.getElementById('slipInput').click()">
            üìé ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            <input type="file" id="slipInput" accept=".pdf,.jpg,.png" style="display:none" onchange="handleSlipUpload(event)">
          </div>
          <div id="slipList"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mTripUpdate')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="updateTrip('arrived')">üìç ‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button>
      <button class="btn btn-success" onclick="updateTrip('completed')">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ============================================================
// DATA STORE (localStorage + Google Sheets sync)
// ============================================================
const SHEET_URL = localStorage.getItem('gasUrl') || '';

const DB = {
  users: JSON.parse(localStorage.getItem('vms_users') || '[]'),
  vehicles: JSON.parse(localStorage.getItem('vms_vehicles') || '[]'),
  drivers: JSON.parse(localStorage.getItem('vms_drivers') || '[]'),
  bookings: JSON.parse(localStorage.getItem('vms_bookings') || '[]'),
  trips: JSON.parse(localStorage.getItem('vms_trips') || '[]'),
  notifications: JSON.parse(localStorage.getItem('vms_notifs') || '[]'),
};

function saveDB(key) {
  localStorage.setItem('vms_' + key, JSON.stringify(DB[key]));
}

function genId(prefix) {
  return prefix + '-' + Date.now().toString(36).toUpperCase();
}

// ============================================================
// SEED DATA
// ============================================================
function initSeedData() {
  if (DB.vehicles.length === 0) {
    DB.vehicles = [
      {id:'V001',plate:'‡∏Å‡∏Ç-1234',brand:'Toyota Commuter',type:'‡∏£‡∏ñ‡∏ï‡∏π‡πâ',cap:10,status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ',mile:142500,prb:'2025-12-31',ins:'2026-05-31',note:''},
      {id:'V002',plate:'‡∏ô‡∏ß-5678',brand:'Toyota Camry',type:'‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á',cap:4,status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ',mile:88200,prb:'2025-06-15',ins:'2025-08-31',note:''},
      {id:'V003',plate:'‡∏Ç‡∏Ç-9012',brand:'Ford Ranger',type:'‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞',cap:4,status:'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á',mile:213000,prb:'2025-06-10',ins:'2025-10-31',note:'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå'},
      {id:'V004',plate:'‡∏û‡∏ô-3456',brand:'Toyota Hiace',type:'‡∏£‡∏ñ‡∏ï‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà',cap:12,status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ',mile:67800,prb:'2025-11-30',ins:'2026-02-28',note:''},
      {id:'V005',plate:'‡∏ö‡∏£-7890',brand:'Honda Accord',type:'‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á',cap:4,status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ',mile:55100,prb:'2026-02-28',ins:'2026-01-15',note:''},
    ];
    saveDB('vehicles');
  }
  if (DB.drivers.length === 0) {
    DB.drivers = [
      {id:'D001',code:'DRV-01',name:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏î‡∏µ',phone:'081-234-5678',email:'somchai@co.th',licType:'‡∏ó.2',licExp:'2030-12-31',status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞'},
      {id:'D002',code:'DRV-02',name:'‡∏ß‡∏¥‡∏ä‡∏≤‡∏î‡∏≤ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô',phone:'082-345-6789',email:'wichada@co.th',licType:'‡∏ó.2',licExp:'2029-08-15',status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞'},
      {id:'D003',code:'DRV-03',name:'‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏°‡∏≤‡∏ô‡∏∞',phone:'083-456-7890',email:'prasert@co.th',licType:'‡∏ó.1',licExp:'2025-07-20',status:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞'},
      {id:'D004',code:'DRV-04',name:'‡∏ô‡∏¥‡∏†‡∏≤ ‡πÉ‡∏ù‡πà‡∏î‡∏µ',phone:'084-567-8901',email:'nipha@co.th',licType:'‡∏ó.2',licExp:'2031-03-10',status:'‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞'},
    ];
    saveDB('drivers');
  }
  if (DB.bookings.length === 0) {
    const base = new Date();
    DB.bookings = [
      {id:'BK-001',docNo:'DOC-2568-001',refNo:'RCV-001',start:fmtDT(addDays(base,-2),'08:30'),end:fmtDT(addDays(base,-2),'17:00'),from:'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà',to:'‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á',purpose:'‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',pax:3,needDriver:1,status:'‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß',requesterId:'U002',requesterName:'‡∏ô.‡∏™. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏î‡∏µ',approvedBy:'‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå',vehicleId:'V001',driverId:'D001',createdAt:new Date().toISOString(),pdfs:[]},
      {id:'BK-002',docNo:'DOC-2568-002',refNo:'',start:fmtDT(addDays(base,3),'06:00'),end:fmtDT(addDays(base,3),'20:00'),from:'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà',to:'‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥',purpose:'‡∏£‡∏±‡∏ö‡πÅ‡∏Ç‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®',pax:1,needDriver:1,status:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',requesterId:'U002',requesterName:'‡∏ô.‡∏™. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏î‡∏µ',approvedBy:'',vehicleId:'',driverId:'',createdAt:new Date().toISOString(),pdfs:[]},
      {id:'BK-003',docNo:'DOC-2568-003',refNo:'RCV-003',start:fmtDT(base,'13:00'),end:fmtDT(base,'18:00'),from:'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà',to:'‡∏®‡∏≤‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á ‡∏à.‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ',purpose:'‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£',pax:2,needDriver:1,status:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',requesterId:'U002',requesterName:'‡∏ô.‡∏™. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏î‡∏µ',approvedBy:'‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå',vehicleId:'',driverId:'',createdAt:new Date().toISOString(),pdfs:[]},
      {id:'BK-004',docNo:'DOC-2568-004',refNo:'',start:fmtDT(addDays(base,4),'09:00'),end:fmtDT(addDays(base,4),'17:00'),from:'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà',to:'‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå',purpose:'‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ',pax:6,needDriver:1,status:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',requesterId:'U003',requesterName:'‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',approvedBy:'',vehicleId:'',driverId:'',createdAt:new Date().toISOString(),pdfs:[]},
      {id:'BK-005',docNo:'DOC-2568-005',refNo:'RCV-005',start:fmtDT(addDays(base,-5),'09:00'),end:fmtDT(addDays(base,-5),'16:00'),from:'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà',to:'‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',purpose:'‡∏≠‡∏ö‡∏£‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',pax:5,needDriver:1,status:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',requesterId:'U002',requesterName:'‡∏ô.‡∏™. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏î‡∏µ',approvedBy:'‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå',vehicleId:'V002',driverId:'D002',createdAt:new Date().toISOString(),pdfs:[]},
    ];
    saveDB('bookings');
  }
  if (DB.users.length === 0) {
    DB.users = [
      {id:'U001',name:'‡∏ô‡∏≤‡∏¢ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö',email:'admin@company.com',role:'admin',dept:'IT',status:'active'},
      {id:'U002',name:'‡∏ô.‡∏™. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏î‡∏µ',email:'user@co.th',role:'user',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',status:'active'},
      {id:'U003',name:'‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',email:'manager@co.th',role:'manager',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',status:'active'},
      {id:'U004',name:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏î‡∏µ',email:'driver@co.th',role:'driver',dept:'‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞',status:'active'},
    ];
    saveDB('users');
  }
  if (DB.notifications.length === 0) {
    DB.notifications = [
      {id:'N001',title:'‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî BK-001',body:'‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏Ç-1234 ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏î‡∏µ ‡πÄ‡∏ß‡∏•‡∏≤ 08:30 ‡∏ô.',time:'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 09:15',unread:true,color:'var(--teal)'},
      {id:'N002',title:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚Äî BK-003',body:'‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‡∏®‡∏≤‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á ‡∏à.‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ',time:'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 08:00',unread:true,color:'var(--green)'},
      {id:'N003',title:'‚ö†Ô∏è ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏µ ‚Äî ‡∏Ç‡∏Ç-9012',body:'‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 10/06/68 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',time:'‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô',unread:true,color:'var(--amber)'},
      {id:'N004',title:'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Äî BK-004',body:'‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ç‡∏≠‡∏£‡∏ñ‡πÑ‡∏õ ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥',time:'‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô',unread:false,color:'var(--accent)'},
    ];
    saveDB('notifications');
  }
}

function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate()+n); return r; }
function fmtDT(d, time) {
  const dd = new Date(d);
  const y = dd.getFullYear(); const m = String(dd.getMonth()+1).padStart(2,'0'); const day = String(dd.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}T${time}`;
}

// ============================================================
// AUTH
// ============================================================
const ACCOUNTS = {
  'admin@company.com': {pass:'admin123',role:'admin',name:'‡∏ô‡∏≤‡∏¢ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö',id:'U001'},
  'user@co.th':        {pass:'1234',   role:'user',  name:'‡∏ô.‡∏™. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏î‡∏µ',id:'U002'},
  'manager@co.th':     {pass:'1234',   role:'manager',name:'‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',id:'U003'},
  'driver@co.th':      {pass:'1234',   role:'driver', name:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏î‡∏µ',id:'U004'},
};

let currentUser = null;

function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const btn = document.getElementById('loginBtnTxt');
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
  setTimeout(() => {
    const acc = ACCOUNTS[email];
    if (acc && acc.pass === pass) {
      currentUser = {email, ...acc};
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('app').classList.add('visible');
      initSeedData();
      setupUI();
      btn.textContent = 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      showToast('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + acc.name,'var(--green)');
    } else {
      document.getElementById('loginErr').classList.add('show');
      document.getElementById('loginErrMsg').textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      btn.textContent = 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }
  }, 800);
}

function loginWithGoogle() {
  showToast('üîó Google OAuth ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Client ID ‡πÉ‡∏ô Settings ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á','var(--amber)');
}

function doLogout() {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) return;
  currentUser = null;
  document.getElementById('app').classList.remove('visible');
  document.getElementById('loginPage').style.display = 'flex';
}

function togglePass() {
  const el = document.getElementById('loginPass');
  el.type = el.type === 'password' ? 'text' : 'password';
}

// ============================================================
// NAV CONFIG
// ============================================================
const NAV = {
  admin: [
    {section:'OVERVIEW', items:[
      {icon:'üìä',label:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',page:'dashboard'},
      {icon:'üìã',label:'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ',page:'bookings',badge:()=>DB.bookings.filter(b=>b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length},
    ]},
    {section:'DISPATCH', items:[
      {icon:'‚úÖ',label:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',page:'approvals',badge:()=>DB.bookings.filter(b=>b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length},
      {icon:'üó∫Ô∏è',label:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ',page:'dispatch',badge:()=>DB.bookings.filter(b=>b.status==='‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length},
      {icon:'üìÖ',label:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Google Calendar',page:'calendar'},
    ]},
    {section:'MANAGEMENT', items:[
      {icon:'üöå',label:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞',page:'vehicles'},
      {icon:'üë®‚Äç‚úàÔ∏è',label:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö',page:'drivers'},
      {icon:'üìà',label:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',page:'reports'},
      {icon:'‚öôÔ∏è',label:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',page:'settings'},
    ]},
  ],
  manager: [
    {section:'MAIN', items:[
      {icon:'üìä',label:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',page:'dashboard'},
      {icon:'‚úÖ',label:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',page:'approvals',badge:()=>DB.bookings.filter(b=>b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length},
      {icon:'üìã',label:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',page:'bookings'},
      {icon:'üìÖ',label:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô',page:'calendar'},
    ]},
  ],
  user: [
    {section:'MAIN', items:[
      {icon:'üìä',label:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',page:'dashboard'},
      {icon:'üìã',label:'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',page:'bookings',badge:()=>DB.bookings.filter(b=>b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'&&b.requesterId===currentUser?.id).length},
      {icon:'üìÖ',label:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô',page:'calendar'},
    ]},
  ],
  driver: [
    {section:'MAIN', items:[
      {icon:'üìä',label:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',page:'dashboard'},
      {icon:'üöó',label:'‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',page:'mytrips',badge:()=>DB.bookings.filter(b=>b.driverId==='D001'&&b.status==='‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß').length},
      {icon:'üìÖ',label:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô',page:'calendar'},
    ]},
  ],
};

const ROLE_META = {
  admin:   {label:'System Admin',   avatarBg:'rgba(20,184,166,.2)',  avatarColor:'var(--teal)'},
  manager: {label:'Manager',        avatarBg:'rgba(245,158,11,.2)',  avatarColor:'var(--amber)'},
  user:    {label:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (User)', avatarBg:'rgba(14,165,233,.2)', avatarColor:'var(--accent2)'},
  driver:  {label:'‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (Driver)', avatarBg:'rgba(34,197,94,.2)',   avatarColor:'var(--green)'},
};

// ============================================================
// UI SETUP
// ============================================================
function setupUI() {
  const meta = ROLE_META[currentUser.role];
  const initials = currentUser.name.substring(0,2);
  document.getElementById('avatarEl').textContent = initials;
  document.getElementById('avatarEl').style.background = meta.avatarBg;
  document.getElementById('avatarEl').style.color = meta.avatarColor;
  document.getElementById('uNameEl').textContent = currentUser.name;
  document.getElementById('uRoleEl').textContent = meta.label;
  renderNav();
  showPage('dashboard');
  renderNotifPanel();
}

let currentPage = 'dashboard';

function renderNav() {
  const navConfig = NAV[currentUser.role] || NAV.user;
  let html = '';
  navConfig.forEach(sec => {
    html += `<div class="nav-section">${sec.section}</div>`;
    sec.items.forEach(item => {
      const cnt = item.badge ? item.badge() : 0;
      html += `<div class="nav-item ${item.page===currentPage?'active':''}" onclick="showPage('${item.page}')">
        <span class="nicon">${item.icon}</span>
        <span class="nlabel">${item.label}</span>
        ${cnt>0?`<span class="nav-badge">${cnt}</span>`:''}
      </div>`;
    });
  });
  document.getElementById('mainNav').innerHTML = html;
}

const PAGE_TITLES = {
  dashboard:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',bookings:'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ',approvals:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
  dispatch:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ',vehicles:'‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞',drivers:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ',
  calendar:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Google Calendar',mytrips:'‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
  reports:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',settings:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö'
};

function showPage(pg) {
  currentPage = pg;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el = document.getElementById('page-'+pg);
  if (el) { el.classList.add('active'); renderPage(pg); }
  document.getElementById('pageTitle').textContent = PAGE_TITLES[pg]||pg;
  renderNav();
}

function renderPage(pg) {
  const fn = {
    dashboard: renderDashboard,
    bookings: renderBookings,
    approvals: renderApprovals,
    dispatch: renderDispatch,
    vehicles: renderVehicles,
    drivers: renderDrivers,
    calendar: renderCalendar,
    mytrips: renderMyTrips,
    reports: renderReports,
  };
  if (fn[pg]) fn[pg]();
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const bks = DB.bookings;
  const stats = [
    {label:'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',val:bks.length,sub:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',cls:'c-blue'},
    {label:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',val:bks.filter(b=>b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length,sub:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',cls:'c-amber'},
    {label:'‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',val:bks.filter(b=>['‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'].includes(b.status)).length,sub:'‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',cls:'c-teal'},
    {label:'‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á',val:DB.vehicles.filter(v=>v.status==='‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ').length,sub:`‡∏à‡∏≤‡∏Å ${DB.vehicles.length} ‡∏Ñ‡∏±‡∏ô`,cls:'c-green'},
  ];
  document.getElementById('dashStats').innerHTML = stats.map(s=>`
    <div class="stat ${s.cls}">
      <div class="s-label">${s.label}</div>
      <div class="s-val">${s.val}</div>
      <div class="s-sub">${s.sub}</div>
    </div>`).join('');

  // recent bookings
  const recent = [...bks].sort((a,b)=>b.id.localeCompare(a.id)).slice(0,5);
  document.getElementById('dashBookingTable').innerHTML = `
    <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
    <tbody>${recent.map(b=>`<tr>
      <td><span class="chip">${b.id}</span></td>
      <td>${b.to}</td>
      <td>${b.start.substring(0,10)}</td>
      <td>${badgeHtml(b.status)}</td>
    </tr>`).join('')}</tbody>`;

  // alerts
  const alerts = [];
  DB.vehicles.forEach(v=>{
    if(v.prb && daysDiff(v.prb)<30) alerts.push({type:'warn',msg:`üöó ${v.plate} ‚Äî ‡∏û‡∏£‡∏ö. ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${v.prb}`});
    if(v.ins && daysDiff(v.ins)<30) alerts.push({type:'warn',msg:`üõ°Ô∏è ${v.plate} ‚Äî ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${v.ins}`});
  });
  if(alerts.length===0) alerts.push({type:'success',msg:'‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô'});
  document.getElementById('dashAlerts').innerHTML = alerts.map(a=>`
    <div class="alert alert-${a.type==='warn'?'warn':'success'}" style="margin:12px">${a.msg}</div>`).join('');
  document.getElementById('lastSync').textContent = '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ';

  // mini calendar
  renderMiniCal();
}

function daysDiff(dateStr) {
  return Math.ceil((new Date(dateStr)-new Date())/(1000*86400));
}

function renderMiniCal() {
  const today = new Date();
  const events = DB.bookings.filter(b=>b.status!=='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'&&b.status!=='‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  const html = `<div style="display:flex;gap:8px;flex-wrap:wrap">` +
    events.map(b=>`<div class="cal-event ev-${b.status==='‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß'?'green':'blue'}" style="padding:6px 10px;border-radius:6px;font-size:12px">
      üóìÔ∏è <strong>${b.id}</strong> ${b.start.substring(5,10)} ‚Üí ${b.to.substring(0,12)}
    </div>`).join('') + '</div>';
  document.getElementById('miniCalBody').innerHTML = html||'<div style="color:var(--text2);font-size:13px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
}

// ============================================================
// BOOKINGS TABLE
// ============================================================
function renderBookings() {
  const bks = currentUser.role==='user'
    ? DB.bookings.filter(b=>b.requesterId===currentUser.id)
    : DB.bookings;
  renderBookingTable('bookingsTbl', bks);
}

function renderBookingTable(tblId, bks) {
  const isAdmin = ['admin','manager'].includes(currentUser.role);
  const tbl = document.getElementById(tblId);
  if(!tbl) return;
  tbl.innerHTML = `
    <thead><tr>
      <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th><th>‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
    </tr></thead>
    <tbody>${bks.map(b=>`<tr data-status="${b.status}">
      <td><span class="chip">${b.id}</span><br><span style="font-size:10px;color:var(--text2)">${b.docNo}</span></td>
      <td>${b.requesterName}</td>
      <td style="font-size:12px">${b.start.replace('T',' ')}</td>
      <td>${b.to}</td>
      <td style="text-align:center">${b.pax}</td>
      <td>${badgeHtml(b.status)}</td>
      <td>${b.pdfs&&b.pdfs.length>0?`<span class="chip" style="cursor:pointer" onclick="viewPDFs('${b.id}')">üìÑ ${b.pdfs.length}</span>`:'‚Äî'}</td>
      <td><div class="td-actions">
        ${isAdmin&&b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'?`<button class="btn btn-success btn-xs" onclick="approveBooking('${b.id}')">‚úì</button>
          <button class="btn btn-danger btn-xs" onclick="openReject('${b.id}')">‚úó</button>`:''}
        ${isAdmin&&b.status==='‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'?`<button class="btn btn-primary btn-xs" onclick="openDispatch('${b.id}')">üöó ‡∏à‡∏±‡∏î‡∏£‡∏ñ</button>`:''}
        <button class="btn btn-ghost btn-xs" onclick="editBooking('${b.id}')">‚úèÔ∏è</button>
        ${isAdmin?`<button class="btn btn-danger btn-xs" onclick="deleteBooking('${b.id}')">üóëÔ∏è</button>`:''}
      </div></td>
    </tr>`).join('')}</tbody>`;
}

// ============================================================
// APPROVALS
// ============================================================
function renderApprovals() {
  const pending = DB.bookings.filter(b=>b.status==='‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  document.getElementById('pendingCount').textContent = pending.length;
  if(pending.length===0){
    document.getElementById('approvalList').innerHTML='<div class="alert alert-success" style="margin:20px">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
    return;
  }
  document.getElementById('approvalList').innerHTML = `
    <div style="display:grid;gap:12px;padding:16px">
      ${pending.map(b=>`
      <div style="background:var(--bg4);border:1px solid var(--border);border-left:3px solid var(--amber);border-radius:10px;padding:16px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div style="font-size:18px">üìã</div>
        <div style="flex:1;min-width:200px">
          <div style="font-size:13px;font-weight:700;margin-bottom:4px">${b.requesterName} ‚Äî ${b.purpose}</div>
          <div style="font-size:12px;color:var(--text3);display:flex;gap:16px;flex-wrap:wrap">
            <span>üìã ${b.id}</span><span>üìÖ ${b.start.replace('T',' ')}</span>
            <span>üìç ${b.to}</span><span>üë• ${b.pax} ‡∏Ñ‡∏ô</span>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0">
          <button class="btn btn-success btn-sm" onclick="approveBooking('${b.id}')">‚úì ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="btn btn-danger btn-sm" onclick="openReject('${b.id}')">‚úó ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        </div>
      </div>`).join('')}
    </div>`;
}

function approveBooking(id) {
  const b = DB.bookings.find(x=>x.id===id);
  if(!b) return;
  b.status = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  b.approvedBy = currentUser.name;
  saveDB('bookings');
  addNotif(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚Äî ${id}`, `${b.purpose} ‚Ä¢ ${b.to}`, 'var(--green)');
  sendEmail(b.requesterId, `[‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥] ‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${id}`, `‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${b.to} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`);
  showToast(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${id} ‡πÅ‡∏•‡πâ‡∏ß ¬∑ ‡∏™‡πà‡∏á Email ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠`,'var(--green)');
  renderPage(currentPage);
  renderNav();
}

function openReject(id) {
  document.getElementById('rejectId').value = id;
  openModal('mReject');
}

function confirmReject() {
  const id = document.getElementById('rejectId').value;
  const reason = document.getElementById('rejectReason').value;
  const note = document.getElementById('rejectNote').value;
  const b = DB.bookings.find(x=>x.id===id);
  if(!b) return;
  b.status = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  b.rejectReason = reason + (note?' ‚Äî '+note:'');
  saveDB('bookings');
  sendEmail(b.requesterId, `[‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥] ‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${id}`, `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`);
  closeModal('mReject');
  showToast(`‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${id} ¬∑ ‡∏™‡πà‡∏á Email ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠`,'var(--red)');
  renderPage(currentPage); renderNav();
}

// ============================================================
// DISPATCH
// ============================================================
function renderDispatch() {
  document.getElementById('ganttDate').textContent = new Date().toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  renderGantt();
  renderDispatchQueue();
}

function renderGantt() {
  const hours = ['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
  let html = `<div class="gantt-head">
    <div class="gantt-res">‡∏£‡∏ñ / ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</div>
    <div class="gantt-tl">${hours.map(h=>`<div class="gantt-h">${h}</div>`).join('')}</div>
  </div>`;
  DB.vehicles.forEach(v=>{
    const driver = DB.drivers.find(d=>d.id===DB.bookings.find(b=>b.vehicleId===v.id&&b.status==='‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß')?.driverId);
    const trips = DB.bookings.filter(b=>b.vehicleId===v.id&&['‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'].includes(b.status));
    html += `<div class="gantt-row">
      <div class="gantt-lbl">
        <div class="v-name">${v.plate} (${v.type})</div>
        <div class="v-sub">${v.status==='‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'?'<span style="color:var(--red)">üîß ‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</span>':driver?driver.name:'‡∏ß‡πà‡∏≤‡∏á'}</div>
      </div>
      <div class="gantt-track">${
        v.status==='‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á'
          ?'<div class="g-block g-red" style="left:0%;width:100%">MAINTENANCE</div>'
          :trips.map(t=>{
              const s = timeToPercent(t.start.split('T')[1]||'08:00');
              const e = timeToPercent(t.end.split('T')[1]||'17:00');
              const w = Math.max(e-s,5);
              return `<div class="g-block g-teal" style="left:${s}%;width:${w}%" title="${t.id} ‚Üí ${t.to}">${t.id} ${t.to.substring(0,8)}</div>`;
            }).join('')
      }</div>
    </div>`;
  });
  document.getElementById('ganttBoard').innerHTML = html;
}

function timeToPercent(timeStr) {
  const [h,m] = timeStr.split(':').map(Number);
  return Math.max(0, Math.min(100, ((h-6)*60+m) / (14*60) * 100));
}

function renderDispatchQueue() {
  const queue = DB.bookings.filter(b=>b.status==='‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  if(!queue.length){
    document.getElementById('dispatchQueue').innerHTML='<div class="alert alert-success" style="margin:16px">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏ñ</div>';
    return;
  }
  document.getElementById('dispatchQueue').innerHTML=`
    <div style="display:grid;gap:10px;padding:16px">
      ${queue.map(b=>`
      <div style="background:var(--bg4);border:1px solid var(--border2);border-radius:10px;padding:14px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <div style="font-size:13px;font-weight:700">${b.requesterName} ‚Äî ${b.purpose}</div>
          <div style="font-size:12px;color:var(--text3);margin-top:4px;display:flex;gap:12px;flex-wrap:wrap">
            <span>${b.id}</span><span>${b.start.replace('T',' ')}</span>
            <span>üìç ${b.to}</span><span>üë• ${b.pax}</span>
          </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openDispatch('${b.id}')">üöó ‡∏à‡∏±‡∏î‡∏£‡∏ñ</button>
      </div>`).join('')}
    </div>`;
}

function openDispatch(id) {
  const b = DB.bookings.find(x=>x.id===id);
  if(!b) return;
  document.getElementById('dspBookingId').value = id;
  document.getElementById('dspInfo').innerHTML = `üìã <strong>${b.requesterName}</strong> ‚Üí <strong>${b.to}</strong> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${b.start.replace('T',' ')} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${b.pax} ‡∏Ñ‡∏ô`;
  const vSel = document.getElementById('dspVehicle');
  vSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>' +
    DB.vehicles.filter(v=>v.status==='‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ').map(v=>`<option value="${v.id}">${v.plate} ‚Äî ${v.brand} (${v.type} ${v.cap} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á)</option>`).join('');
  const dSel = document.getElementById('dspDriver');
  dSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö --</option>' +
    DB.drivers.filter(d=>d.status==='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô').map(d=>`<option value="${d.id}">${d.code} ‚Äî ${d.name} ‡πÇ‡∏ó‡∏£ ${d.phone}</option>`).join('');
  openModal('mDispatch');
}

function confirmDispatch() {
  const id = document.getElementById('dspBookingId').value;
  const vid = document.getElementById('dspVehicle').value;
  const did = document.getElementById('dspDriver').value;
  if(!vid||!did){showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö','var(--amber)');return;}
  const b = DB.bookings.find(x=>x.id===id);
  const v = DB.vehicles.find(x=>x.id===vid);
  const d = DB.drivers.find(x=>x.id===did);
  b.status='‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß'; b.vehicleId=vid; b.driverId=did;
  d.status='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  saveDB('bookings'); saveDB('drivers');
  addNotif(`üöó ‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ${id}`,`‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ${v.plate} ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö ${d.name} ‡πÇ‡∏ó‡∏£ ${d.phone}`,'var(--teal)');
  sendEmail(b.requesterId,`[‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß] ${id}`,`‡∏£‡∏ñ: ${v.plate} (${v.brand})\n‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ${d.name} ‡πÇ‡∏ó‡∏£ ${d.phone}`);
  sendEmail(d.email,`[‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà] ${id}`,`‡πÑ‡∏õ‡∏£‡∏±‡∏ö ${b.requesterName} ‡πÄ‡∏ß‡∏•‡∏≤ ${b.start.replace('T',' ')} ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: ${b.to}`);
  syncCalendarEvent(b, v, d);
  closeModal('mDispatch');
  showToast(`üöó ‡∏à‡∏±‡∏î‡∏£‡∏ñ ${id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ Email + Calendar ‚úì`,'var(--teal)');
  renderPage(currentPage); renderNav();
}

// ============================================================
// VEHICLES CRUD
// ============================================================
function renderVehicles() {
  const t = document.getElementById('vehiclesTbl');
  t.innerHTML = `
    <thead><tr>
      <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏£‡∏∏‡πà‡∏ô</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</th><th>‡∏û‡∏£‡∏ö.‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
    </tr></thead>
    <tbody>${DB.vehicles.map(v=>`<tr data-status="${v.status}">
      <td><strong>${v.plate}</strong></td>
      <td>${v.brand}</td>
      <td>${v.type}</td>
      <td style="text-align:center">${v.cap}</td>
      <td>${badgeVehicle(v.status)}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:12px">${Number(v.mile).toLocaleString()}</td>
      <td style="color:${expiryColor(v.prb)}">${v.prb||'‚Äî'}</td>
      <td style="color:${expiryColor(v.ins)}">${v.ins||'‚Äî'}</td>
      <td style="font-size:12px;color:var(--text3)">${v.note||'‚Äî'}</td>
      <td><div class="td-actions">
        <button class="btn btn-ghost btn-xs" onclick="editVehicle('${v.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn btn-danger btn-xs" onclick="deleteVehicle('${v.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
      </div></td>
    </tr>`).join('')}</tbody>`;
}

function expiryColor(d){
  if(!d) return 'var(--text2)';
  const days = daysDiff(d);
  return days<0?'var(--red)':days<30?'var(--amber)':'var(--green)';
}

function openModal_Vehicle_new() { openModal('mVehicle'); document.getElementById('mVehicleTitle').textContent='üöå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞'; clearForm(['vhEditId','vhPlate','vhBrand','vhNote']); }

function editVehicle(id) {
  const v = DB.vehicles.find(x=>x.id===id);
  document.getElementById('mVehicleTitle').textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞';
  document.getElementById('vhEditId').value=v.id;
  document.getElementById('vhPlate').value=v.plate;
  document.getElementById('vhBrand').value=v.brand;
  document.getElementById('vhType').value=v.type;
  document.getElementById('vhCap').value=v.cap;
  document.getElementById('vhStatus').value=v.status;
  document.getElementById('vhMile').value=v.mile;
  document.getElementById('vhPrb').value=v.prb||'';
  document.getElementById('vhIns').value=v.ins||'';
  document.getElementById('vhNote').value=v.note||'';
  openModal('mVehicle');
}

function saveVehicle() {
  const id = document.getElementById('vhEditId').value || genId('V');
  const data = {
    id, plate:v('vhPlate'),brand:v('vhBrand'),type:v('vhType'),
    cap:Number(v('vhCap')),status:v('vhStatus'),mile:Number(v('vhMile')),
    prb:v('vhPrb'),ins:v('vhIns'),note:v('vhNote')
  };
  const idx = DB.vehicles.findIndex(x=>x.id===id);
  if(idx>=0) DB.vehicles[idx]=data; else DB.vehicles.push(data);
  saveDB('vehicles');
  exportToSheet('vehicles');
  closeModal('mVehicle');
  showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ Sync Google Sheets ‚úì','var(--green)');
  renderVehicles();
}

function deleteVehicle(id) {
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏ô‡∏µ‡πâ?')) return;
  DB.vehicles = DB.vehicles.filter(x=>x.id!==id);
  saveDB('vehicles');
  showToast('üóëÔ∏è ‡∏•‡∏ö‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--red)');
  renderVehicles();
}

// ============================================================
// DRIVERS CRUD
// ============================================================
function renderDrivers() {
  const t = document.getElementById('driversTbl');
  t.innerHTML = `
    <thead><tr>
      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
      <th>‡πÉ‡∏ö‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà</th><th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
    </tr></thead>
    <tbody>${DB.drivers.map(d=>`<tr>
      <td><span class="chip">${d.code}</span></td>
      <td><strong>${d.name}</strong><br><span style="font-size:11px;color:var(--text2)">${d.dept}</span></td>
      <td><a href="tel:${d.phone}" style="color:var(--accent2)">${d.phone}</a></td>
      <td style="font-size:12px">${d.email}</td>
      <td style="text-align:center">${d.licType}</td>
      <td style="color:${expiryColor(d.licExp)}">${d.licExp||'‚Äî'}</td>
      <td>${badgeDriver(d.status)}</td>
      <td><div class="td-actions">
        <button class="btn btn-ghost btn-xs" onclick="editDriver('${d.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-xs" onclick="deleteDriver('${d.id}')">üóëÔ∏è</button>
      </div></td>
    </tr>`).join('')}</tbody>`;
}

function editDriver(id) {
  const d = DB.drivers.find(x=>x.id===id);
  document.getElementById('mDriverTitle').textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö';
  document.getElementById('drEditId').value=d.id;
  document.getElementById('drCode').value=d.code;
  document.getElementById('drName').value=d.name;
  document.getElementById('drPhone').value=d.phone;
  document.getElementById('drEmail').value=d.email;
  document.getElementById('drLicType').value=d.licType;
  document.getElementById('drLicExp').value=d.licExp||'';
  document.getElementById('drStatus').value=d.status;
  document.getElementById('drDept').value=d.dept||'';
  openModal('mDriver');
}

function saveDriver() {
  const id = document.getElementById('drEditId').value || genId('D');
  const data = {
    id,code:v('drCode'),name:v('drName'),phone:v('drPhone'),email:v('drEmail'),
    licType:v('drLicType'),licExp:v('drLicExp'),status:v('drStatus'),dept:v('drDept')
  };
  const idx = DB.drivers.findIndex(x=>x.id===id);
  if(idx>=0) DB.drivers[idx]=data; else DB.drivers.push(data);
  saveDB('drivers');
  exportToSheet('drivers');
  closeModal('mDriver');
  showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ Sync ‚úì','var(--green)');
  renderDrivers();
}

function deleteDriver(id) {
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) return;
  DB.drivers = DB.drivers.filter(x=>x.id!==id);
  saveDB('drivers');
  showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--red)');
  renderDrivers();
}

// ============================================================
// BOOKINGS CRUD
// ============================================================
function saveBooking() {
  const editId = document.getElementById('bkEditId').value;
  const id = editId || genId('BK');
  const data = {
    id, docNo:v('bkDocNo'),refNo:v('bkRefNo'),
    start:v('bkStart'),end:v('bkEnd'),
    from:v('bkFrom'),to:v('bkTo'),
    purpose:v('bkPurpose'),pax:Number(v('bkPax')),
    needDriver:Number(v('bkDriver')),
    status: editId ? DB.bookings.find(x=>x.id===editId)?.status : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
    requesterId: currentUser.id,
    requesterName: currentUser.name,
    approvedBy:'', vehicleId:'', driverId:'',
    createdAt: new Date().toISOString(),
    pdfs: uploadedPdfs,
  };
  const idx = DB.bookings.findIndex(x=>x.id===id);
  if(idx>=0) DB.bookings[idx]={...DB.bookings[idx],...data};
  else DB.bookings.push(data);
  saveDB('bookings');
  exportToSheet('bookings');
  // notify manager
  sendEmail('manager@co.th',`[‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà] ${id}`,`${currentUser.name} ‡∏Ç‡∏≠‡∏£‡∏ñ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${data.to}`);
  addNotif(`üìã ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà ‚Äî ${id}`,`${currentUser.name} ‡∏Ç‡∏≠‡∏£‡∏ñ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${data.to}`,'var(--accent)');
  closeModal('mBooking');
  uploadedPdfs = [];
  document.getElementById('pdfList').innerHTML = '';
  showToast(`üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ ‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`,'var(--green)');
  renderPage(currentPage); renderNav();
}

function editBooking(id) {
  const b = DB.bookings.find(x=>x.id===id);
  document.getElementById('mBookingTitle').textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠';
  document.getElementById('bkEditId').value=b.id;
  document.getElementById('bkDocNo').value=b.docNo;
  document.getElementById('bkRefNo').value=b.refNo||'';
  document.getElementById('bkStart').value=b.start;
  document.getElementById('bkEnd').value=b.end;
  document.getElementById('bkFrom').value=b.from;
  document.getElementById('bkTo').value=b.to;
  document.getElementById('bkPurpose').value=b.purpose;
  document.getElementById('bkPax').value=b.pax;
  openModal('mBooking');
}

function deleteBooking(id) {
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?')) return;
  DB.bookings = DB.bookings.filter(x=>x.id!==id);
  saveDB('bookings');
  showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--red)');
  renderPage(currentPage);
}

// ============================================================
// USERS CRUD
// ============================================================
function renderUsersTable() {
  const t = document.getElementById('usersTbl');
  if(!t) return;
  t.innerHTML = `
    <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr></thead>
    <tbody>${DB.users.map(u=>`<tr>
      <td><strong>${u.name}</strong></td>
      <td style="font-size:12px">${u.email}</td>
      <td><span class="chip">${u.role}</span></td>
      <td>${u.dept||'‚Äî'}</td>
      <td>${u.status==='active'?'<span class="badge b-active">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>':'<span class="badge b-inactive">‡∏£‡∏∞‡∏á‡∏±‡∏ö</span>'}</td>
      <td><div class="td-actions">
        <button class="btn btn-ghost btn-xs" onclick="editUser('${u.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-xs" onclick="deleteUser('${u.id}')">üóëÔ∏è</button>
      </div></td>
    </tr>`).join('')}</tbody>`;
}

function saveUser() {
  const data={id:genId('U'),name:v('usrName'),email:v('usrEmail'),role:v('usrRole'),dept:v('usrDept'),status:v('usrStatus')};
  DB.users.push(data);
  saveDB('users');
  closeModal('mUser');
  showToast('üíæ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--green)');
  renderUsersTable();
}

function deleteUser(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?'))return;
  DB.users=DB.users.filter(x=>x.id!==id);saveDB('users');renderUsersTable();
}

function editUser(id){/*simplified*/openModal('mUser');}

// ============================================================
// CALENDAR
// ============================================================
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();

function renderCalendar() {
  const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  document.getElementById('calMonthTitle').textContent = `${months[calMonth]} ${calYear+543}`;
  const days = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];
  let html = days.map(d=>`<div class="cal-day-head">${d}</div>`).join('');
  const first = new Date(calYear,calMonth,1).getDay();
  const total = new Date(calYear,calMonth+1,0).getDate();
  const today = new Date();
  for(let i=0;i<first;i++) html+=`<div class="cal-day other-month"><div class="cal-num" style="color:var(--text2)">${new Date(calYear,calMonth,-(first-i-1)).getDate()}</div></div>`;
  for(let d=1;d<=total;d++){
    const isToday = d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const evts = DB.bookings.filter(b=>b.start.startsWith(dateStr));
    const warns = DB.vehicles.filter(v=>v.prb===dateStr||v.ins===dateStr);
    html += `<div class="cal-day ${isToday?'today':''}">
      <div class="cal-num">${d}</div>
      ${evts.map(e=>`<div class="cal-event ${e.status==='‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß'?'ev-green':'ev-blue'}" title="${e.id} ${e.to}">${e.id}</div>`).join('')}
      ${warns.map(w=>`<div class="cal-event ev-amber">‚ö†Ô∏è${w.plate}</div>`).join('')}
    </div>`;
  }
  document.getElementById('calGrid').innerHTML = html;
}

function prevMonth(){if(calMonth===0){calMonth=11;calYear--;}else calMonth--;renderCalendar();}
function nextMonth(){if(calMonth===11){calMonth=0;calYear++;}else calMonth++;renderCalendar();}

function syncCalendar() {
  showToast('üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync Google Calendar...','var(--accent)');
  setTimeout(()=>showToast('‚úÖ Sync Google Calendar ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ 5 Events ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï','var(--green)'),1200);
}

function syncCalendarEvent(b,v,d) {
  console.log(`[GCal] Create event: ${b.id} ${b.start} ‚Üí ${b.to} Vehicle:${v.plate} Driver:${d.name}`);
  // In production: call Google Calendar API here
}

// ============================================================
// DRIVER MY TRIPS
// ============================================================
function renderMyTrips() {
  const myBks = DB.bookings.filter(b=>b.driverId===currentUser.driverId||b.driverId==='D001');
  if(!myBks.length){
    document.getElementById('myTripsList').innerHTML='<div class="alert alert-success">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
    return;
  }
  document.getElementById('myTripsList').innerHTML = myBks.map(b=>{
    const v = DB.vehicles.find(x=>x.id===b.vehicleId);
    const steps = [{lbl:'‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',done:true},{lbl:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',done:b.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'||b.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'},{lbl:'‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',done:b.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'},{lbl:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',done:b.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'}];
    const curr = b.status==='‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß'?1:b.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'?2:b.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?4:1;
    return `<div class="card" style="border-left:3px solid var(--accent);margin-bottom:16px">
      <div class="card-body">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <div>
            <div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text2);margin-bottom:4px">${b.id} ‚Ä¢ ${badgeHtml(b.status)}</div>
            <h3>${b.to}</h3>
            <p style="font-size:12px;color:var(--text3);margin-top:4px">${b.start.replace('T',' ')}</p>
          </div>
        </div>
        <div class="timeline" style="margin-bottom:16px">
          ${steps.map((s,i)=>`<div class="tl-step ${s.done?'done':i===curr?'curr':''}">
            <div class="tl-dot">${s.done?'‚úì':i+1}</div>
            ${i<steps.length-1?'<div class="tl-line"></div>':''}
          </div>`).join('')}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;margin-bottom:14px">
          <div><span style="color:var(--text2)">‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£:</span> ${b.requesterName}</div>
          <div><span style="color:var(--text2)">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ:</span> ${v?v.plate:'‚Äî'}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" onclick="openTripUpdate('${b.id}','start')">üöó ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
          <button class="btn btn-ghost btn-sm" onclick="openTripUpdate('${b.id}','arrived')">üìç ‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button>
          <button class="btn btn-success btn-sm" onclick="openTripUpdate('${b.id}','completed')">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openTripUpdate(id, action) {
  const b = DB.bookings.find(x=>x.id===id);
  document.getElementById('tripUpdateId').value = id;
  document.getElementById('mTripTitle').textContent = action==='completed'?'‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå':'üöó ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  document.getElementById('tripInfo').innerHTML = `<strong>${b.id}</strong> ‚Üí ${b.to} ‚Ä¢ ${b.requesterName}`;
  openModal('mTripUpdate');
}

function updateTrip(action) {
  const id = document.getElementById('tripUpdateId').value;
  const b = DB.bookings.find(x=>x.id===id);
  const d = DB.drivers.find(x=>x.id===b.driverId||x.id==='D001');
  if(action==='completed'){
    b.status='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
    b.mileEnd=v('tripMileEnd');
    b.expenses={fuel:Number(v('tripFuel')),toll:Number(v('tripToll'))};
    if(d) d.status='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô';
    const vh = DB.vehicles.find(x=>x.id===b.vehicleId);
    if(vh&&b.mileEnd) vh.mile=Number(b.mileEnd);
    saveDB('vehicles');
  } else if(action==='arrived') {
    b.status='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  }
  saveDB('bookings'); saveDB('drivers');
  closeModal('mTripUpdate');
  showToast(action==='completed'?'‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß':'üìç ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß','var(--green)');
  renderPage(currentPage);
}

// ============================================================
// REPORTS
// ============================================================
function renderReports() {
  const bks = DB.bookings;
  document.getElementById('reportStats').innerHTML = [
    {label:'‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',val:bks.filter(b=>b.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length,sub:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',cls:'c-blue'},
    {label:'‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',val:DB.vehicles.length,sub:`‡∏ß‡πà‡∏≤‡∏á ${DB.vehicles.filter(v=>v.status==='‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ').length} ‡∏Ñ‡∏±‡∏ô`,cls:'c-teal'},
    {label:'‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)',val:'28,450',sub:'‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 5.9 ‡∏ö./‡∏Å‡∏°.',cls:'c-amber'},
    {label:'‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ö‡∏≤‡∏ó)',val:'3,210',sub:'37 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',cls:'c-red'},
  ].map(s=>`<div class="stat ${s.cls}"><div class="s-label">${s.label}</div><div class="s-val">${s.val}</div><div class="s-sub">${s.sub}</div></div>`).join('');

  const depts = [{name:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',cnt:24,pct:72},{name:'‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô',cnt:18,pct:54},{name:'‡∏ù‡πà‡∏≤‡∏¢ IT',cnt:15,pct:45},{name:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•',cnt:12,pct:36},{name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ',cnt:18,pct:54}];
  document.getElementById('deptReport').innerHTML = depts.map(d=>`<div class="rbar">
    <div class="rbar-head"><span>${d.name}</span><span style="font-family:'JetBrains Mono',monospace">${d.cnt} ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</span></div>
    <div class="rbar-track"><div class="rbar-fill" style="width:${d.pct}%;background:var(--accent)"></div></div>
  </div>`).join('');

  document.getElementById('costTable').innerHTML = `
    <thead><tr><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</th><th>‡∏ã‡πà‡∏≠‡∏°</th><th>‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô</th></tr></thead>
    <tbody>
      <tr><td>‡πÄ‡∏°.‡∏¢.</td><td>22,100</td><td>8,500</td><td>2,800</td></tr>
      <tr><td>‡∏û.‡∏Ñ.</td><td>25,600</td><td>3,200</td><td>3,100</td></tr>
      <tr style="color:var(--accent2);font-weight:700"><td>‡∏°‡∏¥.‡∏¢.</td><td>28,450</td><td>1,800</td><td>3,210</td></tr>
    </tbody>`;

  document.getElementById('vehicleReportTbl').innerHTML = `
    <thead><tr><th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th><th>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</th><th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th><th>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</th><th>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</th></tr></thead>
    <tbody>${DB.vehicles.map(vh=>`<tr>
      <td><strong>${vh.plate}</strong></td><td>${vh.brand}</td>
      <td>${Math.floor(Math.random()*20)+5}</td>
      <td style="font-family:'JetBrains Mono',monospace">${(Math.random()*2000+500).toFixed(0)}</td>
      <td>${(Math.random()*5000+2000).toFixed(0)}</td>
      <td><div style="background:rgba(255,255,255,.06);border-radius:3px;height:6px;width:80px"><div style="height:100%;border-radius:3px;background:var(--green);width:${Math.floor(Math.random()*60+40)}%"></div></div></td>
    </tr>`).join('')}</tbody>`;
}

function exportReport() { showToast('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...','var(--accent)'); setTimeout(()=>showToast('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--green)'),1500); }
function sendEmailReport() { showToast('üìß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á Email...','var(--accent)'); setTimeout(()=>showToast('‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Email ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--green)'),1500); }

// ============================================================
// GOOGLE SHEETS SYNC
// ============================================================
async function exportToSheet(tableName) {
  const gasUrl = localStorage.getItem('gasUrl') || '';
  if(!gasUrl){
    console.log(`[Sheets] Not configured yet. Data: ${tableName}`);
    return;
  }
  try {
    const res = await fetch(gasUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'write', table:tableName, data:DB[tableName]})
    });
    const result = await res.json();
    console.log('[Sheets] Sync result:', result);
    document.getElementById('connStatus').className='conn-status connected';
    document.getElementById('connTxt').textContent='Google Sheets ‚úì';
  } catch(e) {
    console.warn('[Sheets] Offline/not configured:', e.message);
  }
}

function syncData() {
  showToast('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö Google Sheets...','var(--accent)');
  setTimeout(()=>{
    document.getElementById('lastSync').textContent='‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ';
    showToast('‚úÖ Sync ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ¬∑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß','var(--green)');
  },1200);
}

function testSheetConn() {
  const id = document.getElementById('sheetId').value;
  if(!id){showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Spreadsheet ID','var(--amber)');return;}
  showToast('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...','var(--accent)');
  setTimeout(()=>showToast('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','var(--green)'),1000);
}

function saveSheetConfig() {
  const url = document.getElementById('sheetId').value;
  localStorage.setItem('gasUrl', url);
  showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets ‡πÅ‡∏•‡πâ‡∏ß','var(--green)');
}

// ============================================================
// EMAIL (via Apps Script)
// ============================================================
async function sendEmail(toId, subject, body) {
  const gasUrl = localStorage.getItem('gasUrl') || '';
  const user = DB.users.find(u=>u.id===toId||u.email===toId);
  const email = user?.email || toId;
  console.log(`[Email] To: ${email} | Subject: ${subject}`);
  if(gasUrl){
    try {
      await fetch(gasUrl, {method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'sendEmail', to:email, subject, body})});
    } catch(e){ console.warn('[Email] Failed:', e.message); }
  }
}

function sendTestEmail() {
  showToast('üìß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Test Email...','var(--accent)');
  setTimeout(()=>showToast('‚úÖ ‡∏™‡πà‡∏á Test Email ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Inbox ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì','var(--green)'),1000);
}

function connectCalendar() {
  showToast('üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar...','var(--accent)');
  setTimeout(()=>showToast('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','var(--green)'),1200);
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function addNotif(title, body, color) {
  DB.notifications.unshift({id:genId('N'),title,body,time:'‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ',unread:true,color});
  if(DB.notifications.length>20) DB.notifications.pop();
  saveDB('notifications');
  const cnt = DB.notifications.filter(n=>n.unread).length;
  document.getElementById('notifCount').textContent = cnt;
  renderNotifPanel();
}

function renderNotifPanel() {
  const cnt = DB.notifications.filter(n=>n.unread).length;
  document.getElementById('notifCount').textContent = cnt||'';
  document.getElementById('notifCount').style.display = cnt?'flex':'none';
  document.getElementById('npList').innerHTML = DB.notifications.map(n=>`
    <div class="np-item ${n.unread?'unread':''}" style="border-left-color:${n.color||'var(--accent)'}" onclick="markRead('${n.id}')">
      <div class="npt"><div class="np-dot" style="background:${n.color||'var(--accent)'}"></div>${n.title}</div>
      <div class="npb">${n.body}</div>
      <div class="npts">${n.time}</div>
    </div>`).join('');
}

function markRead(id) {
  const n = DB.notifications.find(x=>x.id===id);
  if(n) n.unread = false;
  saveDB('notifications');
  renderNotifPanel();
}

// ============================================================
// USERS TABLE (for settings tab)
// ============================================================
function renderUsersOnTabSwitch() { if(document.getElementById('set-users').classList.contains('active')) renderUsersTable(); }

function switchTab(tabId) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabId).classList.add('active');
  if(tabId==='set-users') renderUsersTable();
}

// ============================================================
// PDF HANDLING
// ============================================================
let uploadedPdfs = [];

function dragOver(e){ e.preventDefault(); document.getElementById('pdfZone').classList.add('drag-over'); }
function dragLeave(e){ document.getElementById('pdfZone').classList.remove('drag-over'); }
function dropFile(e){
  e.preventDefault();
  document.getElementById('pdfZone').classList.remove('drag-over');
  handleFiles(e.dataTransfer.files);
}
function handlePdfUpload(e){ handleFiles(e.target.files); }

function handleFiles(files) {
  [...files].forEach(f=>{
    if(f.size>10*1024*1024){showToast('‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB','var(--amber)');return;}
    const reader = new FileReader();
    reader.onload = (ev)=>{
      uploadedPdfs.push({name:f.name,size:formatSize(f.size),data:ev.target.result.substring(0,50)+'...'});
      renderPdfList();
    };
    reader.readAsDataURL(f);
  });
}

function handleSlipUpload(e) {
  const f = e.target.files[0];
  if(!f) return;
  document.getElementById('slipList').innerHTML = `<div class="pdf-item" style="margin-top:8px">
    <span class="pdf-icon">üìé</span>
    <div class="pdf-info"><div class="pdf-name">${f.name}</div><div class="pdf-size">${formatSize(f.size)}</div></div>
  </div>`;
  showToast('üìé ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','var(--green)');
}

function renderPdfList() {
  document.getElementById('pdfList').innerHTML = uploadedPdfs.map((p,i)=>`
    <div class="pdf-item">
      <span class="pdf-icon">üìÑ</span>
      <div class="pdf-info"><div class="pdf-name">${p.name}</div><div class="pdf-size">${p.size}</div></div>
      <button class="btn btn-danger btn-xs" onclick="uploadedPdfs.splice(${i},1);renderPdfList()">‚úï</button>
    </div>`).join('');
}

function formatSize(b){ return b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB'; }
function viewPDFs(id){ showToast('üìÑ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive)','var(--accent)'); }

// ============================================================
// FILTER / SEARCH
// ============================================================
function filterTable(input, tblId) {
  const q = input.value.toLowerCase();
  document.querySelectorAll(`#${tblId} tbody tr`).forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function filterByStatus(sel, tblId) {
  const val = sel.value.toLowerCase();
  document.querySelectorAll(`#${tblId} tbody tr`).forEach(tr=>{
    tr.style.display = !val || (tr.dataset.status||'').toLowerCase().includes(val) ? '' : 'none';
  });
}

// ============================================================
// HELPERS
// ============================================================
function v(id){ return document.getElementById(id)?.value||''; }
function clearForm(ids){ ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); }

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-bg').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('open'); }));

function toggleSidebar(){
  const s = document.getElementById('sidebar');
  if(window.innerWidth<768) s.classList.toggle('mobile-open');
  else s.classList.toggle('collapsed');
}

function toggleNotif(){ document.getElementById('notifPanel').classList.toggle('open'); }

let toastTimer;
function showToast(msg, color) {
  const t = document.getElementById('toast');
  t.innerHTML = msg;
  t.style.borderLeft = `3px solid ${color||'var(--accent)'}`;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 3200);
}

function badgeHtml(status) {
  const map = {'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':'b-pending','‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':'b-approved','‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':'b-rejected','‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß':'b-dispatched','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á':'b-inprogress','‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô':'b-completed'};
  return `<span class="badge ${map[status]||'b-pending'}">${status}</span>`;
}
function badgeVehicle(s){
  const m={'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ':'b-active','‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á':'b-maintenance','‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':'b-inactive'};
  return `<span class="badge ${m[s]||'b-inactive'}">${s}</span>`;
}
function badgeDriver(s){
  const m={'‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô':'b-active','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á':'b-inprogress','‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î':'b-completed','‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢':'b-rejected'};
  return `<span class="badge ${m[s]||'b-inactive'}">${s}</span>`;
}

// Date display
document.addEventListener('DOMContentLoaded', ()=>{
  // Enter key on login
  document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
});
</script>

</body>
</html>
